<title>Polygon Triangulation</title>
<canvas id="cvs" width="640" height="480"></canvas>
<style>
* { 
  margin: 0;
}
canvas { 
  width: 100%;
  height: 100%;
  background: lightgray; 
}
</style>

<script>

init()

function init() {
  cvs = document.getElementById("cvs");
  ctx = cvs.getContext("2d");
  finished = false;
  points = [];
  cvs.addEventListener("mouseup", onMouseUp);
  requestAnimationFrame(animate);

  steppos=0;
  document.addEventListener("keydown", (e)=>{
    if(e.key=='a')
    {
      steppos++;
    }
    if(e.key=='b')
    {
      steppos=0;
      steppos=999;
      points=generateRandomPolygon(50,0,0,cvs.width,cvs.height);
    }
    if(e.key=='c')
    {
      steppos=0;
    }
  });
  //points=JSON.parse('[{"x":1.3100271745796022,"y":305.91626844878255},{"x":61.60780269078202,"y":319.47502776716027},{"x":91.36708261027138,"y":394.97696976994445},{"x":106.95448448818752,"y":307.77686750693647},{"x":85.26037818596919,"y":441.289621868563},{"x":116.11546035223682,"y":386.9294840937358},{"x":204.91577246753067,"y":293.7084112805337},{"x":264.4438992195642,"y":288.45607034732865},{"x":76.53569793957317,"y":453.0795266143049},{"x":159.84250575590806,"y":442.69932564005563},{"x":226.19879674251806,"y":415.50753339598367},{"x":143.28769847262421,"y":394.7522428611277},{"x":251.33770056694672,"y":339.3738457987681},{"x":315.92176184960863,"y":299.8226476263461},{"x":377.43177354205443,"y":359.37788875432443},{"x":326.6141699179882,"y":369.48845744284705},{"x":218.25987994097062,"y":379.2153496344023},{"x":208.01307317929286,"y":400.0714352087085},{"x":408.51013168358133,"y":390.00234450485374},{"x":63.639373313468326,"y":468.36924008699907},{"x":527.9986079930038,"y":465.3879856354905},{"x":523.0285330443214,"y":448.4250057642475},{"x":106.80795469613258,"y":463.9218455326215},{"x":298.42467278128765,"y":456.1273828275619},{"x":333.7013266344833,"y":446.16286083048044},{"x":330.13514055812976,"y":440.4826449067138},{"x":468.9020543937538,"y":374.6237348926446},{"x":442.2891551805924,"y":395.65596633894734},{"x":454.36788012082206,"y":388.3510233097795},{"x":511.4875926715868,"y":448.19182942874033},{"x":503.63364125045933,"y":431.3981772988534},{"x":629.0494657798722,"y":407.9686434713455},{"x":581.4966490900824,"y":402.339303629172},{"x":503.46267086625244,"y":357.19411934886926},{"x":486.0063726368146,"y":382.48035907506835},{"x":489.4870507891209,"y":390.4161324639813},{"x":475.66176890992654,"y":369.2432647532654},{"x":394.515493614718,"y":363.036350998691},{"x":431.9181678188434,"y":347.60231643257896},{"x":421.082025825049,"y":329.2456776562491},{"x":591.0429577349408,"y":383.8347821731665},{"x":389.5293335411857,"y":284.4447191197063},{"x":515.55272143247,"y":342.0053848957625},{"x":588.5512628836498,"y":362.6622885664567},{"x":609.622616649538,"y":323.01261491617606},{"x":583.5212815499825,"y":346.57011801788485},{"x":504.53520888539714,"y":315.2682854139834},{"x":606.8047225228925,"y":235.61469213570064},{"x":631.1381053426624,"y":228.7174502000014},{"x":584.4611630016419,"y":35.03890894873315},{"x":587.5287142530698,"y":124.94422002681276},{"x":576.4120075283199,"y":135.61253763908275},{"x":592.8906270675825,"y":197.4797252446443},{"x":565.7038549136844,"y":149.7684568890458},{"x":560.912581728336,"y":213.29978781967324},{"x":566.3488525479352,"y":8.027090394327558},{"x":535.9212965220057,"y":259.24960332553144},{"x":503.447754274152,"y":6.063909985535396},{"x":508.21456300768216,"y":137.77623977870405},{"x":471.88941360146475,"y":27.128833933773393},{"x":465.95452981328503,"y":50.13054058759387},{"x":484.66487614519053,"y":67.28130047716824},{"x":428.7468246058057,"y":89.94492703737279},{"x":419.9163042470954,"y":31.597907849259705},{"x":395.38460067798144,"y":35.30740243474163},{"x":10.288807153545747,"y":16.042539345360964},{"x":93.98714489252015,"y":116.43249165501373},{"x":224.77481370349835,"y":102.29822947307717},{"x":235.04515395531925,"y":27.661275779684473},{"x":359.0280060435474,"y":64.73432242057754},{"x":359.74454459756305,"y":45.88040851882816},{"x":439.1041033292936,"y":103.74582657377232},{"x":395.91364277328535,"y":75.62048574390803},{"x":384.748418739637,"y":105.5769164250172},{"x":361.37580438527806,"y":129.308079861658},{"x":463.41261441161606,"y":129.3870774641086},{"x":468.43566082799043,"y":173.00390020853382},{"x":439.18804192552716,"y":135.43075595232781},{"x":393.31114342015337,"y":145.82849774341528},{"x":500.49227170318176,"y":251.24411796325742},{"x":406.33847982812154,"y":201.21671492354756},{"x":408.34760164514137,"y":198.66750890469876},{"x":370.3633484575741,"y":147.89086357819656},{"x":419.1795643808182,"y":220.4600914464164},{"x":405.0089758531553,"y":210.37539429964392},{"x":338.9668876995421,"y":191.76570581962167},{"x":350.7309343958094,"y":101.51903335977039},{"x":254.7450997213926,"y":142.74323790834003},{"x":263.9384408148602,"y":212.8883040357981},{"x":198.76080511879763,"y":260.24347939530065},{"x":164.74391936697003,"y":113.68232185140644},{"x":142.12903731944223,"y":218.05756715993485},{"x":134.91612822707225,"y":176.89895800826588},{"x":97.68760428546315,"y":208.90972265829046},{"x":106.16225267419125,"y":284.38115093634826},{"x":68.48665176155208,"y":138.50667176250994},{"x":32.72164777841752,"y":185.29583948852928},{"x":34.3546998549634,"y":247.86226773673815},{"x":83.39133961589127,"y":295.198875714643},{"x":101.57950183503004,"y":302.565482890195}]');
  //points=JSON.parse('[{"x":261.59798149705637,"y":137.83783783783784},{"x":206.1564339781329,"y":205.40540540540542},{"x":348.25904121110176,"y":247.56756756756758},{"x":442.45584524810766,"y":220},{"x":439.7645079899075,"y":154.59459459459458},{"x":355.2565180824222,"y":132.97297297297297},{"x":397.2413793103448,"y":201.0810810810811},{"x":373.01934398654333,"y":214.05405405405406},{"x":296.0470984020185,"y":209.1891891891892},{"x":273.9781328847771,"y":196.75675675675674},{"x":285.82001682085786,"y":153.51351351351352},{"x":318.1160639192599,"y":138.3783783783784},{"x":320.80740117746006,"y":118.37837837837837},{"x":309.5037846930193,"y":89.1891891891892},{"x":276.13120269133725,"y":78.37837837837837},{"x":265.3658536585366,"y":100.54054054054055},{"x":288.51135407905804,"y":108.10810810810811},{"x":290.6644238856182,"y":133.51351351351352},{"x":275.0546677880572,"y":147.56756756756758},{"x":271.825063078217,"y":188.1081081081081},{"x":257.29184188393606,"y":196.21621621621622},{"x":256.215306980656,"y":171.8918918918919},{"x":264.82758620689657,"y":164.32432432432432}]');
  //points=JSON.parse('[{"x":158.39174996464195,"y":404.2299743947252},{"x":230.13696789776859,"y":110.74022009765199},{"x":277.6213652770225,"y":166.62043902372773},{"x":219.1489217862555,"y":43.317237304713565},{"x":322.6889941352286,"y":191.81903476054285},{"x":320.4794619785392,"y":257.2740803565678},{"x":310.73252070030594,"y":424.57871114518827},{"x":409.8336588578029,"y":27.49462347255129},{"x":528.008771993769,"y":234.74788988650292},{"x":567.3633947321412,"y":470.5977046111831}]');
  //points=JSON.parse('[{"x":6.740947360166274,"y":108.32846695502693},{"x":33.12371888708867,"y":10.946251481355134},{"x":12.700992578396892,"y":187.38663767592493},{"x":51.15186623384034,"y":291.6936488564952},{"x":169.3430617596951,"y":278.00026941558946},{"x":210.47466480346444,"y":282.5006949432595},{"x":217.73878842141528,"y":201.63337625595653},{"x":192.45725190827756,"y":211.8100883440401},{"x":104.77078040073252,"y":212.76985388386788},{"x":112.9852944383434,"y":168.91137269067076},{"x":94.05823541780606,"y":246.20621681189567},{"x":83.03285237432405,"y":252.93444450529853},{"x":98.14328365218572,"y":175.87727229252664},{"x":19.31199899546357,"y":179.39009626586537},{"x":55.40688645118806,"y":28.79459644526655},{"x":41.61343060620581,"y":95.37777599920491},{"x":64.75616741647087,"y":54.64690096897371},{"x":127.08823515991227,"y":150.21980498856084},{"x":82.36627645052337,"y":35.12537293345929},{"x":100.13353358083933,"y":61.049576752750916},{"x":126.04767503043632,"y":68.47037486221616},{"x":153.15082533253332,"y":137.5723609610909},{"x":188.62394833701302,"y":181.4729610605515},{"x":194.0339723410679,"y":143.84802468979984},{"x":244.75185529941967,"y":253.20765510289573},{"x":162.66187991028914,"y":325.36606403453027},{"x":249.19977428476528,"y":319.70958973625477},{"x":431.8272516788618,"y":278.97027218109076},{"x":219.77729055358637,"y":319.02835837135547},{"x":289.64186120554047,"y":142.81557924110362},{"x":136.95934805507505,"y":16.500018436174102},{"x":237.89209817208857,"y":62.43140953204296},{"x":233.85905371904101,"y":30.0017893197521},{"x":285.165572857363,"y":90.45260885585276},{"x":300.31730838534827,"y":200.55646142660802},{"x":286.9721567408608,"y":155.54508727477685},{"x":257.57544792479194,"y":229.51550749312403},{"x":275.1164481789735,"y":216.6127308758915},{"x":404.7930430901465,"y":179.0881328533149},{"x":381.1441128913512,"y":255.8804724041315},{"x":429.72469511407724,"y":208.05210960123915},{"x":414.6650273040646,"y":82.29229565209013},{"x":446.95595815148124,"y":131.4098513637742},{"x":452.95347803540426,"y":272.42953946803885},{"x":484.9420002327801,"y":313.2344848960302},{"x":487.59290502114396,"y":313.51268155987236},{"x":452.34643226212324,"y":238.37126721088475},{"x":516.4543933613661,"y":151.7581753746291},{"x":508.5986806067957,"y":147.82958287115687},{"x":531.5361943956173,"y":135.47495651040205},{"x":461.6071976787906,"y":97.73352893411428},{"x":550.0841460872432,"y":44.212769289216816},{"x":365.65706444885154,"y":61.96916932777082},{"x":572.905472543389,"y":41.95703707061188},{"x":410.41609378194124,"y":49.56681586634165},{"x":552.6951571296477,"y":17.33686675814809},{"x":281.1006856727972,"y":36.79427757077278},{"x":85.4928567569496,"y":0.9569186496459281},{"x":617.9152643407733,"y":17.052090859297273},{"x":605.9753851740979,"y":92.81517874136206},{"x":526.8205394824424,"y":168.3725070113383},{"x":554.1900962150012,"y":168.15271890151695},{"x":614.8148511247699,"y":130.50545607486566},{"x":578.6901056441365,"y":164.1398275235416},{"x":575.05073410693,"y":178.30277043430465},{"x":639.9781793598629,"y":167.51766383075505},{"x":571.1930840477148,"y":193.08170218308803},{"x":540.3519144461746,"y":213.58202195846573},{"x":515.4771163362116,"y":311.9954000470283},{"x":636.3512578864276,"y":206.6659657247337},{"x":530.5563955634733,"y":324.43290950171735},{"x":579.2429004172825,"y":332.4822203571325},{"x":541.6618435824689,"y":336.5946592042361},{"x":555.8741397557296,"y":349.6333255367558},{"x":574.7360543531945,"y":368.7823724738484},{"x":509.81070270665555,"y":313.159144569116},{"x":503.3099929421999,"y":358.8898800458232},{"x":290.3227281900175,"y":388.5733285902028},{"x":492.3361068964458,"y":398.5962413984137},{"x":482.7090048886662,"y":400.3756882673479},{"x":270.6200509382178,"y":464.07614970461003},{"x":449.8525604204441,"y":463.5625036692374},{"x":315.47144831705066,"y":461.1954602393632},{"x":509.72534418134,"y":394.39831679273834},{"x":501.5322413920353,"y":399.1358531902222},{"x":512.5173539268202,"y":421.7993480235039},{"x":543.9588084870837,"y":448.0620782647645},{"x":583.4121656972866,"y":365.41827072890953},{"x":589.557475207961,"y":321.7018284817823},{"x":625.1331905945405,"y":472.30019871526713},{"x":49.48025486968348,"y":477.4572203980083},{"x":67.79463279357898,"y":477.1108865151874},{"x":25.588837487928515,"y":441.8598034473081},{"x":92.472507232781,"y":450.8927095309544},{"x":241.42931675230997,"y":466.1953415333968},{"x":218.398581766276,"y":442.64176955771524},{"x":278.05080523693846,"y":446.84876492589234},{"x":273.93625733447294,"y":431.3690027663575},{"x":265.22777780098227,"y":346.749468229031},{"x":4.627115087279208,"y":377.09378631755123}]');
  //finished=true;
  alert("press b to generate random polygon\npress c to reset the animation\npress a to step animation\n");


  setInterval(() => {
    //steppos++;
  }, 50);
}

function animate() {
 try {
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    ctx.lineWidth = 1;
    ctx.strokeStyle = finished ? "green" : "red";
    ctx.beginPath();
    if (points.length > 0) {
      ctx.moveTo(points[0].x, points[0].y);
      for (let i = 1; i < points.length; i++) {
        ctx.lineTo(points[i].x, points[i].y);
      }
      if (finished) {
        ctx.closePath();
      }
    }
    ctx.stroke();
    if (finished) {
      ctx.strokeStyle = "blue";
      for (const monotonePolygon of decompose(points)) {
        drawPolygon(monotonePolygon);
        if (monotonePolygon.length == 2) {
          for (var i1 = points.length - 1, i2 = 0; i2 < points.length; i1 = i2, i2++) {
            if (testSegments(points[i1], points[i2], monotonePolygon[0], monotonePolygon[1])) {
              console.log("SORRY")
            }
          }
        }
      }
    }
    requestAnimationFrame(animate);
  //try{
    
  }
  catch (e) {
    console.log("unexpected exception while decomposing polygon!");
    console.log(JSON.stringify(points));
  }
}

function drawPolygon(polygon) {
  ctx.beginPath();
  ctx.moveTo(polygon[0].x, polygon[0].y);
  for (let i = 1; i < polygon.length; i++) {
    ctx.lineTo(polygon[i].x, polygon[i].y);
  }
  ctx.closePath();
  ctx.stroke();
}

function onMouseUp(e) {
  if (finished) {
    finished = false;
    points = [];
    return;
  }
  const rect = cvs.getBoundingClientRect();
  const x = (event.clientX - rect.left) * cvs.width / rect.width;
  const y = (event.clientY - rect.top) * cvs.height / rect.height;
  const r = 10;
  if (points.length > 0 && (x - points[0].x) ** 2 + (y - points[0].y) ** 2 < r ** 2) {
    finished = true;
    return;
  }
  if (points.length > 0 && (x - points[points.length - 1].x) ** 2 + (y - points[points.length - 1].y) ** 2 < r ** 2) {
    return;
  }
  points.push({ x: x, y: y });
}

function distanceFromSegment(a, b, p) {
  // Calculate vector from 'a' to 'b'
  var abX = b.x - a.x;
  var abY = b.y - a.y;

  // Calculate vector from 'a' to 'p'
  var apX = p.x - a.x;
  var apY = p.y - a.y;

  // Calculate dot product of ab and ap
  var dotProduct = abX * apX + abY * apY;

  // Calculate length squared of ab
  var abLengthSquared = abX * abX + abY * abY;

  // Calculate 't' value
  var t = Math.max(0, Math.min(1, dotProduct / abLengthSquared));

  // Calculate projected point
  var projectedX = a.x + t * abX;
  var projectedY = a.y + t * abY;

  // Calculate the distance
  var distance = (p.x - projectedX) * (p.x - projectedX) + (p.y - projectedY) * (p.y - projectedY);

  return distance;
}

function testSegments(a1, b1, a2, b2) {
  // Calculate vectors
  var v1x = b1.x - a1.x;
  var v1y = b1.y - a1.y;
  var v2x = b2.x - a2.x;
  var v2y = b2.y - a2.y;

  // Calculate the cross products
  var cross1 = v1x * (a2.y - a1.y) - v1y * (a2.x - a1.x);
  var cross2 = v1x * (b2.y - a1.y) - v1y * (b2.x - a1.x);
  var cross3 = v2x * (a1.y - a2.y) - v2y * (a1.x - a2.x);
  var cross4 = v2x * (b1.y - a2.y) - v2y * (b1.x - a2.x);

  // Check if segments are parallel and non-intersecting
  if (cross1 * cross2 >= 0 || cross3 * cross4 >= 0) {
    return false;
  }

  return true;
}

function generateRandomPolygon(n, x1, y1, x2, y2) {
  // generate random points
  var points = [];
  for (var i = 0; i < n; i++) {
    points[i] = { x: x1 + Math.random() * (x2 - x1), y: y1 + Math.random() * (y2 - y1) };
  }
  points.sort((a, b) => a.x - b.x);
  // generate a convex hull
  var polygon = [];
  polygon.push(points[0]);
  polygon.push(points[1]);
  for (var i = 2; i < points.length; i++) {
    while (polygon.length >= 2 && cross(polygon[polygon.length - 2], polygon[polygon.length - 1], points[i]) >= 0) {
      polygon.pop();
    }
    polygon.push(points[i]);
  }
  // keep adding inner points which dont ruin the simplicity of the polygon
  // only adding the closest point to a segment ensures that no point gets outside the polygon
  // O(n^3)
  while (true) {
    var options = [];
    for (var i1 = polygon.length - 1, i2 = 0; i2 < polygon.length; i1 = i2, i2++) {
      var minDistance = Infinity;
      var minIndex = -1;
      for (var j = 0; j < points.length; j++) {
        if (polygon.includes(points[j])) {
          continue;
        }
        var bad = false;
        for (var k1 = polygon.length - 1, k2 = 0; k2 < polygon.length; k1 = k2, k2++) {
          if (testSegments(polygon[i1], points[j], polygon[k1], polygon[k2]) || testSegments(polygon[i2], points[j], polygon[k1], polygon[k2])) {
            bad = true;
            break;
          }
        }
        if (bad) {
          continue;
        }
        var distance = distanceFromSegment(polygon[i1], polygon[i2], points[j]);
        if (distance < minDistance) {
          minDistance = distance;
          minIndex = j;
        }
      }
      if (minIndex == -1) {
        continue;
      }
      options.push({ i: i1, j: minIndex })
    }
    if (options.length == 0) {
      break;
    }
    var choice = options[Math.floor(Math.random() * options.length)];
    polygon.splice(choice.i + 1, 0, points[choice.j]);
  }
  // check the winding
  if (cross(polygon[1], polygon[0], polygon[polygon.length - 1]) < 0) {
    polygon.reverse();
  }
  return polygon;
}

// algorithm begins

function decompose(polygon) {
  var n = polygon.length;
  var v = new Array(n);
  var w = new Array(n);
  var l = new Array(n);
  var r = new Array(n);
  var u = new Array(n);
  var m = new Array(n);
  var a = new Array(n);
  for (var i = 0; i < n; i++) {
    v[i] = { x: polygon[i].x, y: polygon[i].y };
    w[i] = i;
    l[i] = i == 0 ? n - 1 : i - 1;
    r[i] = i == n - 1 ? 0 : i + 1;
    u[i] = 0;
    m[i] = 0;
  }
  for (var i = 0; i < n; i++) {
    a[i] = cross(v[l[i]], v[i], v[r[i]]);
  }
  w.sort((i, j) => v[i].x - v[j].x);
  var e = new Array();
  function insert(i, j) {
    e.push({i: i, j: j, orig: j});
  }
  function remove(i) {
    e.splice(e.findIndex((o) => o.i == i), 1);
  }
  function has(i) {
    return e.find((o) => o.i == i) != undefined;
  }
  function get(i) {
    return e.find((o) => o.i == i).j;
  }
  function set(i, j) {
    e.find((o) => o.i == i).j = j;
  }
  function ceil(k) {
    e.sort((a, b) => {
      if (cross(v[a.i], v[a.orig], v[b.i]) >= 0 && cross(v[a.i], v[a.orig], v[b.orig]) >= 0) {
        return 1;
      }
      if (cross(v[a.i], v[a.orig], v[b.i]) < 0 && cross(v[a.i], v[a.orig], v[b.orig]) < 0) {
        return -1;
      }
      if (cross(v[b.i], v[b.orig], v[a.i]) < 0 && cross(v[b.i], v[b.orig], v[a.orig]) < 0) {
        return 1;
      }
      if (cross(v[b.i], v[b.orig], v[a.i]) >= 0 && cross(v[b.i], v[b.orig], v[a.orig]) >= 0) {
        return -1;
      }
      alert("edges intersect");
    });
    for (var {i, j, orig} of e) {
      if (cross(v[i], v[orig], v[k]) > 0) {
        return i;
      }
    }
    alert("no edge above point");
  }
  function fix(i, k) {
    var j = get(i);
    if (m[j]) {
      m[j] = 0;
      s.push([v[j], v[k]]);
    }
  }
  var s = new Array();
  var cc=0;
  for (var i of w) {
    if(cc++==steppos) {
      //s=[];
      s.push([v[i], {x:v[i].x+10,y:v[i].y+10}]);
      for (var {i, j, orig} of e) {
        s.push([v[i], v[orig]]);
      }
      return s;
    }
    switch (u[l[i]] + u[r[i]]) {
      case 0: {
        if (a[i] <= 0) {
          // start vertex
          insert(cross(v[l[i]], v[i], v[r[i]]) > 0 ? l[i] : r[i], i);
        }
        else {
          // split vertex
          var c = ceil(i);
          s.push([v[i], v[get(c)]]);
          set(c, i);
          insert(cross(v[l[i]], v[i], v[r[i]]) < 0 ? l[i] : r[i], i);
        }
        break;
      }
      case 1: {
        if (has(i)) {
          // upper chain vertex
          fix(i, i);
          remove(i);
          insert(v[l[i]].x > v[r[i]].x ? l[i] : r[i], i);
        }
        else {
          // lower chain vertex
          var c = ceil(i);
          fix(c, i);
          set(c, i);
        }
        break;
      }
      case 2: {
        if (a[i] <= 0) {
          // end vertex
          fix(i, i);
          remove(i);
        }
        else {
          // merge vertex
          m[i] = 1;
          fix(i, i);
          remove(i);
          var c = ceil(i);
          fix(c, i);
          set(c, i);
        }
        break;
      }
    }
    u[i] = 1;
  }
  return s;
}

function cross(a, b, c) {
  return (b.x - a.x) * (c.y - b.y) - (b.y - a.y) * (c.x - b.x);
}

</script>
